import{r as p}from"./index-GiUgBvb1.js";const q=["password","token","apiKey","secret","authorization","creditCard","cardNumber","cvv","ssn"];function L(u,e={}){const s=e.keys||q;if(!u||typeof u!="object")return u;const r=Array.isArray(u)?[...u]:{...u},i=c=>{if(!c||typeof c!="object")return c;for(const n in c)if(Object.prototype.hasOwnProperty.call(c,n)){const l=n.toLowerCase();s.some(g=>l.includes(g.toLowerCase()))?c[n]="***REDACTED***":c[n]!==null&&typeof c[n]=="object"&&(c[n]=i(c[n]))}return c};return i(r)}function S(u){return u.replace(/[^a-z0-9_\-]/gi,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function _(){if(typeof navigator>"u")return"unknown";const u=navigator.userAgent;return u.includes("Edg")?"edge":u.includes("Chrome")?"chrome":u.includes("Firefox")?"firefox":u.includes("Safari")?"safari":"unknown"}function U(u,e,s,r){if(typeof window>"u")return{sessionId:u,environment:e,userId:s,timestamp:new Date().toISOString(),userAgent:"",browser:"unknown",platform:"",language:"",screenResolution:"0x0",viewport:"0x0",url:"",referrer:"",timezone:"",logCount:r,errorCount:0,networkErrorCount:0};const i=typeof window.screen<"u"?`${window.screen.width}x${window.screen.height}`:"0x0",c=typeof window.innerWidth<"u"&&typeof window.innerHeight<"u"?`${window.innerWidth}x${window.innerHeight}`:"0x0";return{sessionId:u,environment:e,userId:s,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,browser:_(),platform:navigator.platform,language:navigator.language,screenResolution:i,viewport:c,url:window.location.href,referrer:document.referrer,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,logCount:r,errorCount:0,networkErrorCount:0}}function v(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}function F(u="json",e={},s={}){const{fileNameTemplate:r="{env}_{userId}_{sessionId}_{timestamp}",environment:i="development",userId:c="anonymous",sessionId:n="unknown"}=s,l=new Date().toISOString().replace(/[:.]/g,"-").split(".")[0],d=new Date().toISOString().split("T")[0],g=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/:/g,"-"),w=s.browser||_(),C=s.platform||(typeof navigator<"u"?navigator.platform:"unknown"),R=(s.url||(typeof window<"u"?window.location.pathname.replace(/\//g,"_"):"unknown")).split("?")[0]||"unknown",m=String(s.errorCount??e.errorCount??0),b=String(s.logCount??e.logCount??0);let k=r.replace("{env}",S(i)).replace("{userId}",S(c??"anonymous")).replace("{sessionId}",S(n??"unknown")).replace("{timestamp}",l).replace("{date}",d).replace("{time}",g).replace(/\{errorCount\}/g,m).replace(/\{logCount\}/g,b).replace("{browser}",S(w)).replace("{platform}",S(C)).replace("{url}",S(R));for(const[O,H]of Object.entries(e))k=k.replace(`{${O}}`,String(H));return`${k}.${u}`}class K{constructor(){this.originalConsole={log:console.log.bind(console),error:console.error.bind(console),warn:console.warn.bind(console),info:console.info.bind(console),debug:console.debug.bind(console)},this.callbacks=[]}attach(){Object.keys(this.originalConsole).forEach(e=>{const s=this.originalConsole[e];console[e]=(...r)=>{this.callbacks.forEach(i=>{i(e,r)}),s(...r)}})}detach(){Object.keys(this.originalConsole).forEach(e=>{console[e]=this.originalConsole[e]})}onLog(e){this.callbacks.push(e)}}class ${constructor(e={}){this.originalFetch=window.fetch.bind(window),this.onRequest=[],this.onResponse=[],this.onError=[],this.excludeUrls=(e.excludeUrls||[]).map(s=>new RegExp(s))}attach(){window.fetch=async(...e)=>{const[s,r]=e,i=s.toString();if(this.excludeUrls.some(n=>n.test(i)))return this.originalFetch(...e);const c=Date.now();this.onRequest.forEach(n=>n(i,r||{}));try{const n=await this.originalFetch(...e),l=n.clone(),d=Date.now()-c;let g;try{g=await l.text()}catch{g="[Unable to read response body]"}return this.onResponse.forEach(w=>w(i,n.status,d)),n}catch(n){throw this.onError.forEach(l=>l(i,n)),n}}}detach(){window.fetch=this.originalFetch}onFetchRequest(e){this.onRequest.push(e)}onFetchResponse(e){this.onResponse.push(e)}onFetchError(e){this.onError.push(e)}}class z{constructor(e={}){this.originalXHR=window.XMLHttpRequest,this.onRequest=[],this.onResponse=[],this.onError=[],this.requestTracker=new WeakMap,this.excludeUrls=(e.excludeUrls||[]).map(s=>new RegExp(s))}attach(){const e=this.originalXHR,s=this,r=function(){const n=new e;return s.requestTracker.set(n,{method:"",url:"",headers:{},body:null,startTime:Date.now()}),n};r.prototype=e.prototype,Object.setPrototypeOf(r.prototype,e.prototype);const i=e.prototype.open;r.prototype.open=function(n,l){const d=s.requestTracker.get(this);if(d){if(d.method=n,d.url=l,s.excludeUrls.some(g=>g.test(l)))return i.apply(this,[n,l]);for(const g of s.onRequest)g(d)}return i.apply(this,[n,l])};const c=e.prototype.send;r.prototype.send=function(n){const l=s.requestTracker.get(this);return l&&(l.body=n,this.onload=()=>{const d=Date.now()-l.startTime;for(const g of s.onResponse)g(l,this.status,d)},this.onerror=()=>{for(const d of s.onError)d(l,new Error("XHR Error"))}),c.apply(this,[n])},window.XMLHttpRequest=r}detach(){window.XMLHttpRequest=this.originalXHR}onXHRRequest(e){this.onRequest.push(e)}onXHRResponse(e){this.onResponse.push(e)}onXHRError(e){this.onError.push(e)}}const x=class x{static isSupported(){return this.supported===null&&(this.supported=typeof window<"u"&&"showDirectoryPicker"in window),this.supported}static async saveToDirectory(e,s,r="application/json"){if(!this.isSupported())throw new Error("File System Access API not supported");try{const n=await(await(await window.showDirectoryPicker()).getFileHandle(s,{create:!0})).createWritable();await n.write(e),await n.close()}catch(i){if(i.name==="AbortError")return;throw i}}static download(e,s,r="application/json"){const i=new Blob([e],{type:r}),c=URL.createObjectURL(i),n=document.createElement("a");n.href=c,n.download=s,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(c)}static async downloadWithFallback(e,s,r="application/json"){if(this.isSupported())try{await this.saveToDirectory(e,s,r);return}catch(i){if(i.name==="AbortError")return}this.download(e,s,r)}};x.supported=null;let T=x;const P={maxLogs:1e3,enablePersistence:!0,persistenceKey:"debug_logs",captureConsole:!0,captureFetch:!0,captureXHR:!0,enableDirectoryPicker:!1,sanitizeKeys:["password","token","apiKey","secret","authorization","creditCard"],excludeUrls:[],fileNameTemplate:"{env}_{userId}_{sessionId}_{timestamp}",environment:"development",userId:null,sessionId:null,includeMetadata:!0,uploadEndpoint:null,uploadOnError:!1,uploadOnErrorCount:5};function j(u={}){const e={...P,...u},s=p.useRef({maxLogs:e.maxLogs,enablePersistence:e.enablePersistence,persistenceKey:e.persistenceKey,captureConsole:e.captureConsole,captureFetch:e.captureFetch,captureXHR:e.captureXHR,sanitizeKeys:e.sanitizeKeys,includeMetadata:e.includeMetadata,uploadEndpoint:e.uploadEndpoint,uploadOnErrorCount:e.uploadOnErrorCount});p.useEffect(()=>{s.current={maxLogs:e.maxLogs,enablePersistence:e.enablePersistence,persistenceKey:e.persistenceKey,captureConsole:e.captureConsole,captureFetch:e.captureFetch,captureXHR:e.captureXHR,sanitizeKeys:e.sanitizeKeys,includeMetadata:e.includeMetadata,uploadEndpoint:e.uploadEndpoint,uploadOnErrorCount:e.uploadOnErrorCount}},[e]);const r=p.useRef([]),i=p.useRef(e.sessionId||v()),c=p.useRef(U(i.current,e.environment,e.userId,0)),[n,l]=p.useState(0),d=p.useRef(0),g=p.useRef(!1),w=p.useCallback(h=>{const o=new Set;return JSON.stringify(h,(a,t)=>{if(typeof t=="object"&&t!==null){if(o.has(t))return"[Circular]";o.add(t)}return t})},[]),C=p.useMemo(()=>new K,[]),E=p.useMemo(()=>new $({excludeUrls:e.excludeUrls}),[e.excludeUrls]),R=p.useMemo(()=>new z({excludeUrls:e.excludeUrls}),[e.excludeUrls]),m=p.useCallback(h=>{const o=s.current;r.current.push(h),r.current.length>o.maxLogs&&r.current.shift(),l(r.current.length),h.type==="CONSOLE"?h.level==="ERROR"?d.current++:d.current=0:h.type==="FETCH_ERR"||h.type==="XHR_ERR"?d.current++:d.current=0;const a=o.uploadOnErrorCount??5;if(d.current>=a&&o.uploadEndpoint){const t={metadata:{...c.current,logCount:r.current.length},logs:r.current,fileName:F("json",{},e)};fetch(o.uploadEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:w(t)}).catch(()=>{}),d.current=0}if(o.enablePersistence&&typeof window<"u")try{localStorage.setItem(o.persistenceKey,w(r.current))}catch{console.warn("[useLogRecorder] Failed to persist logs")}},[w]),b=p.useCallback(()=>{const h=r.current.filter(a=>a.type==="CONSOLE").reduce((a,t)=>t.level==="ERROR"?a+1:a,0),o=r.current.filter(a=>a.type==="FETCH_ERR"||a.type==="XHR_ERR").length;c.current={...c.current,logCount:r.current.length,errorCount:h,networkErrorCount:o}},[]);p.useEffect(()=>{if(typeof window>"u"||g.current)return;if(g.current=!0,e.enablePersistence)try{const o=localStorage.getItem(e.persistenceKey);o&&(r.current=JSON.parse(o),l(r.current.length))}catch{console.warn("[useLogRecorder] Failed to load persisted logs")}const h=[];if(e.captureConsole&&(C.attach(),C.onLog((o,a)=>{const t=a.map(f=>{if(typeof f=="object")try{return w(f)}catch{return String(f)}return String(f)}).join(" ");m({type:"CONSOLE",level:o.toUpperCase(),time:new Date().toISOString(),data:t.substring(0,5e3)})}),h.push(()=>C.detach())),e.captureFetch){const o=new Map;E.onFetchRequest((a,t)=>{const f=Math.random().toString(36).substring(7);let y=null;if(t!=null&&t.body)try{y=typeof t.body=="string"?JSON.parse(t.body):t.body,y=L(y,{keys:e.sanitizeKeys})}catch{y=String(t.body).substring(0,1e3)}o.set(f,{url:a,method:(t==null?void 0:t.method)||"GET",headers:L(t==null?void 0:t.headers,{keys:e.sanitizeKeys}),body:y}),m({type:"FETCH_REQ",id:f,url:a,method:(t==null?void 0:t.method)||"GET",headers:L(t==null?void 0:t.headers,{keys:e.sanitizeKeys}),body:y,time:new Date().toISOString()})}),E.onFetchResponse((a,t,f)=>{for(const[y,I]of o.entries())if(I.url===a){o.delete(y),m({type:"FETCH_RES",id:y,url:a,status:t,statusText:"",duration:`${f}ms`,body:"[Response captured by interceptor]",time:new Date().toISOString()});break}}),E.onFetchError((a,t)=>{for(const[f,y]of o.entries())if(y.url===a){o.delete(f),m({type:"FETCH_ERR",id:f,url:a,error:t.toString(),duration:"[unknown]ms",time:new Date().toISOString()});break}}),E.attach(),h.push(()=>E.detach())}return e.captureXHR&&(R.onXHRRequest(o=>{m({type:"XHR_REQ",id:Math.random().toString(36).substring(7),url:o.url,method:o.method,headers:o.headers,body:o.body,time:new Date().toISOString()})}),R.onXHRResponse((o,a,t)=>{m({type:"XHR_RES",id:Math.random().toString(36).substring(7),url:o.url,status:a,statusText:"",duration:`${t}ms`,body:"[Response captured by interceptor]",time:new Date().toISOString()})}),R.onXHRError((o,a)=>{m({type:"XHR_ERR",id:Math.random().toString(36).substring(7),url:o.url,error:a.message,duration:"[unknown]ms",time:new Date().toISOString()})}),R.attach(),h.push(()=>R.detach())),()=>{h.forEach(o=>o()),g.current=!1}},[e,m,w,C,E,R]);const k=p.useCallback((h="json",o)=>{if(typeof window>"u")return null;b();const a=o||F(h,{},e);let t,f;if(h==="json"){const y=e.includeMetadata?{metadata:c.current,logs:r.current}:r.current;t=w(y),f="application/json"}else t=(e.includeMetadata?`${"=".repeat(80)}
METADATA
${"=".repeat(80)}
${w(c.current)}
${"=".repeat(80)}

`:"")+r.current.map(I=>`[${I.time}] ${I.type}
${w(I)}
${"=".repeat(80)}`).join(`
`),f="text/plain";return T.downloadWithFallback(t,a,f),a},[e,w,b]),O=p.useCallback(async h=>{const o=h||e.uploadEndpoint;if(!o)return{success:!1,error:"No endpoint configured"};try{b();const a={metadata:c.current,logs:r.current,fileName:F("json",{},e)},t=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:w(a)});if(!t.ok)throw new Error(`Upload failed: ${t.status}`);return{success:!0,data:await t.json()}}catch(a){const t=a instanceof Error?a.message:"Unknown error";return console.error("[useLogRecorder] Failed to upload logs:",a),{success:!1,error:t}}},[e.uploadEndpoint,w,b]),H=p.useCallback(()=>{if(r.current=[],l(0),d.current=0,e.enablePersistence&&typeof window<"u")try{localStorage.removeItem(e.persistenceKey)}catch{console.warn("[useLogRecorder] Failed to clear persisted logs")}},[e.enablePersistence,e.persistenceKey]),M=p.useCallback(()=>[...r.current],[]),D=p.useCallback(()=>n,[n]),X=p.useCallback(()=>(b(),{...c.current}),[b]);return{downloadLogs:k,uploadLogs:O,clearLogs:H,getLogs:M,getLogCount:D,getMetadata:X,sessionId:i.current}}export{j as u};
