import {useRef,useState,useCallback,useEffect}from'react';import {jsxs,Fragment,jsx}from'react/jsx-runtime';// @ts-nocheck
var Q=["password","token","apiKey","secret","authorization","creditCard","cardNumber","cvv","ssn"];function D(r,t={}){let o=t.keys||Q;if(!r||typeof r!="object")return r;let m=Array.isArray(r)?[...r]:{...r},v=c=>{if(!c||typeof c!="object")return c;for(let f in c)if(Object.prototype.hasOwnProperty.call(c,f)){let h=f.toLowerCase();o.some(b=>h.includes(b.toLowerCase()))?c[f]="***REDACTED***":c[f]!==null&&typeof c[f]=="object"&&(c[f]=v(c[f]));}return c};return v(m)}function M(r){return r.replace(/[^a-z0-9_\-]/gi,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function A(){if(typeof navigator>"u")return "unknown";let r=navigator.userAgent;return r.includes("Chrome")?"chrome":r.includes("Firefox")?"firefox":r.includes("Safari")?"safari":r.includes("Edge")?"edge":"unknown"}function W(r,t,o,m){return typeof window>"u"?{sessionId:r,environment:t,userId:o,timestamp:new Date().toISOString(),userAgent:"",browser:"unknown",platform:"",language:"",screenResolution:"0x0",viewport:"0x0",url:"",referrer:"",timezone:"",logCount:m,errorCount:0,networkErrorCount:0}:{sessionId:r,environment:t,userId:o,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,browser:A(),platform:navigator.platform,language:navigator.language,screenResolution:`${window.screen.width}x${window.screen.height}`,viewport:`${window.innerWidth}x${window.innerHeight}`,url:window.location.href,referrer:document.referrer,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,logCount:m,errorCount:0,networkErrorCount:0}}function B(){return `session_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}function j(r="json",t={},o={}){let{fileNameTemplate:m="{env}_{userId}_{sessionId}_{timestamp}",environment:v="development",userId:c="anonymous",sessionId:f="unknown"}=o,h=new Date().toISOString().replace(/[:.]/g,"-").split(".")[0],p=new Date().toISOString().split("T")[0],b=new Date().toLocaleTimeString("en-US",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/:/g,"-"),L=o.browser||A(),S=o.platform||(typeof navigator<"u"?navigator.platform:"unknown"),z=(o.url||(typeof window<"u"?window.location.pathname.replace(/\//g,"_"):"unknown")).split("?")[0]||"unknown",U=String(o.errorCount??t.errorCount??0),H=String(o.logCount??t.logCount??0),T=m.replace("{env}",M(v)).replace("{userId}",M(c??"anonymous")).replace("{sessionId}",M(f??"unknown")).replace("{timestamp}",h).replace("{date}",p).replace("{time}",b).replace(/\{errorCount\}/g,U).replace(/\{logCount\}/g,H).replace("{browser}",M(L)).replace("{platform}",M(S)).replace("{url}",M(z));for(let[P,_]of Object.entries(t))T=T.replace(`{${P}}`,String(_));return `${T}.${r}`}function le(r,t="json"){let o=r.url.split("?")[0]||"unknown";return j(t,{},{environment:r.environment,userId:r.userId,sessionId:r.sessionId,browser:r.browser,platform:r.platform,url:o,errorCount:r.errorCount,logCount:r.logCount})}var Y={maxLogs:1e3,enablePersistence:true,persistenceKey:"debug_logs",captureConsole:true,captureFetch:true,captureXHR:true,sanitizeKeys:["password","token","apiKey","secret","authorization","creditCard"],excludeUrls:[],fileNameTemplate:"{env}_{userId}_{sessionId}_{timestamp}",environment:"development",userId:null,sessionId:null,includeMetadata:true,uploadEndpoint:null,uploadOnError:false};function F(r={}){let t={...Y,...r},o=useRef([]),m=useRef(false),v=useRef(t.sessionId||B()),c=useRef(W(v.current,t.environment,t.userId,0)),[f,h]=useState(0),p=useCallback(s=>{let i=new Set;return JSON.stringify(s,(a,n)=>{if(typeof n=="object"&&n!==null){if(i.has(n))return "[Circular]";i.add(n);}return n})},[]),b=useCallback(s=>{if(o.current.push(s),o.current.length>t.maxLogs&&o.current.shift(),h(o.current.length),t.enablePersistence&&typeof window<"u")try{localStorage.setItem(t.persistenceKey,p(o.current));}catch{console.warn("[useLogRecorder] Failed to persist logs");}},[t.maxLogs,t.enablePersistence,t.persistenceKey,p]),L=useCallback(()=>{if(t.enablePersistence&&typeof window<"u")try{let s=localStorage.getItem(t.persistenceKey);s&&(o.current=JSON.parse(s),h(o.current.length));}catch{console.warn("[useLogRecorder] Failed to load persisted logs");}},[t.enablePersistence,t.persistenceKey]),S=useCallback(s=>t.excludeUrls.some(i=>s.includes(i)),[t.excludeUrls]);useEffect(()=>{if(typeof window>"u"||m.current)return;m.current=true,L();let s=[];if(t.captureConsole){let i={log:console.log,error:console.error,warn:console.warn,info:console.info,debug:console.debug},a=(n,e)=>{try{let u=e.map(g=>{if(typeof g=="object")try{return p(g)}catch{return String(g)}return String(g)}).join(" ");b({type:"CONSOLE",level:n.toUpperCase(),time:new Date().toISOString(),data:u.substring(0,5e3)});}catch{}};Object.keys(i).forEach(n=>{let e=i[n];console[n]=(...u)=>{a(n,u),e.apply(console,u);};}),s.push(()=>{Object.keys(i).forEach(n=>{console[n]=i[n];});});}if(t.captureFetch&&typeof window<"u"){let i=window.fetch;window.fetch=async(...a)=>{let[n,e]=a,u=typeof n=="string"?n:n.url||"";if(S(u))return i(...a);let g=Date.now(),k=Math.random().toString(36).substring(7);try{let y=null;if(e?.body)try{y=typeof e.body=="string"?JSON.parse(e.body):e.body,y=D(y,{keys:t.sanitizeKeys});}catch{y=String(e.body).substring(0,1e3);}b({type:"FETCH_REQ",id:k,url:u,method:e?.method||"GET",headers:D(e?.headers,{keys:t.sanitizeKeys}),body:y,time:new Date().toISOString()});let R=await i(...a),N=R.clone(),O=null;try{R.headers.get("content-type")?.includes("application/json")?(O=await N.json(),O=D(O,{keys:t.sanitizeKeys})):O=(await N.text()).substring(0,1e3);}catch{O="[Unable to parse response]";}return b({type:"FETCH_RES",id:k,url:u,status:R.status,statusText:R.statusText,duration:`${Date.now()-g}ms`,body:O,time:new Date().toISOString()}),R}catch(y){throw b({type:"FETCH_ERR",id:k,url:u,error:y instanceof Error?y.toString():String(y),duration:`${Date.now()-g}ms`,time:new Date().toISOString()}),y}},s.push(()=>{window.fetch=i;});}if(t.captureXHR&&typeof window<"u"){let i=window.XMLHttpRequest,a=function(){let n=new i,e=Math.random().toString(36).substring(7),u,g,k=Date.now(),y=n.open,R=n.send,N=n.setRequestHeader,O={};return n.setRequestHeader=function(x,w){return O[x]=w,N.call(n,x,w)},n.open=function(x,w,E=true){return u=x,g=w,S(w),y.call(n,x,w,E)},n.send=function(x){if(g&&!S(g)){let w=null;if(x)try{w=typeof x=="string"?JSON.parse(x):x,w=D(w,{keys:t.sanitizeKeys});}catch{w=String(x).substring(0,1e3);}b({type:"XHR_REQ",id:e,url:g||"unknown",method:u||"GET",headers:D(O,{keys:t.sanitizeKeys}),body:w,time:new Date().toISOString()}),n.addEventListener("load",function(){let E=null;try{n.getResponseHeader("content-type")?.includes("application/json")?(E=JSON.parse(n.responseText),E=D(E,{keys:t.sanitizeKeys})):E=n.responseText.substring(0,1e3);}catch{E="[Unable to parse response]";}b({type:"XHR_RES",id:e,url:g||"unknown",status:n.status,statusText:n.statusText,duration:`${Date.now()-k}ms`,body:E,time:new Date().toISOString()});}),n.addEventListener("error",function(){b({type:"XHR_ERR",id:e,url:g||"unknown",error:"Network request failed",duration:`${Date.now()-k}ms`,time:new Date().toISOString()});});}return R.call(n,x)},Object.setPrototypeOf(n,i.prototype),n};Object.setPrototypeOf(a.prototype,i.prototype),window.XMLHttpRequest=a,s.push(()=>{window.XMLHttpRequest=i;});}return ()=>{s.forEach(i=>i()),m.current=false;}},[t,b,L,S,p]);let I=useCallback(()=>{let s=o.current.filter(a=>a.type==="CONSOLE"&&a.level==="ERROR").length,i=o.current.filter(a=>a.type==="FETCH_ERR"||a.type==="XHR_ERR").length;c.current={...c.current,logCount:o.current.length,errorCount:s,networkErrorCount:i};},[]),z=useCallback((s="json",i)=>{if(typeof window>"u")return null;try{I();let a=i||j(s,{},t),n,e;if(s==="json"){let y=t.includeMetadata?{metadata:c.current,logs:o.current}:o.current;n=p(y),e="application/json";}else n=(t.includeMetadata?`${"=".repeat(80)}
METADATA
${"=".repeat(80)}
${p(c.current)}
${"=".repeat(80)}

`:"")+o.current.map(R=>`[${R.time}] ${R.type}
${p(R)}
${"=".repeat(80)}`).join(`
`),e="text/plain";let u=new Blob([n],{type:e}),g=URL.createObjectURL(u),k=document.createElement("a");return k.href=g,k.download=a,document.body.appendChild(k),k.click(),document.body.removeChild(k),URL.revokeObjectURL(g),a}catch{return console.error("[useLogRecorder] Failed to download logs"),null}},[t,p,I]),U=useCallback(async s=>{let i=s||t.uploadEndpoint;if(!i)return {success:false,error:"No endpoint configured"};try{I();let a={metadata:c.current,logs:o.current,fileName:j("json",{},t)},n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:p(a)});if(!n.ok)throw new Error(`Upload failed: ${n.status}`);return {success:!0,data:await n.json()}}catch(a){let n=a instanceof Error?a.message:"Unknown error";return console.error("[useLogRecorder] Failed to upload logs:",a),{success:false,error:n}}},[t.uploadEndpoint,p,I]),H=useCallback(()=>{if(o.current=[],h(0),t.enablePersistence&&typeof window<"u")try{localStorage.removeItem(t.persistenceKey);}catch{console.warn("[useLogRecorder] Failed to clear persisted logs");}},[t.enablePersistence,t.persistenceKey]),T=useCallback(()=>[...o.current],[]),P=useCallback(()=>f,[f]),_=useCallback(()=>(I(),{...c.current}),[I]);return {downloadLogs:z,uploadLogs:U,clearLogs:H,getLogs:T,getLogCount:P,getMetadata:_,sessionId:v.current}}function ee({user:r,environment:t="production",uploadEndpoint:o,fileNameTemplate:m="{env}_{date}_{time}_{userId}_{errorCount}errors",maxLogs:v=2e3,showInProduction:c=false}){let[f,h]=useState(false),[p,b]=useState(false),[L,S]=useState(null),{downloadLogs:I,uploadLogs:z,clearLogs:U,getLogCount:H,getMetadata:T,sessionId:P}=F({fileNameTemplate:m,environment:t,userId:r?.id||r?.email||"guest",includeMetadata:true,uploadEndpoint:o,maxLogs:v,captureConsole:true,captureFetch:true,captureXHR:true,sanitizeKeys:["password","token","apiKey","secret","authorization","creditCard"],excludeUrls:["/api/analytics","google-analytics.com","facebook.com","vercel.com"]}),_=H(),s=T();useEffect(()=>{let e=u=>{u.ctrlKey&&u.shiftKey&&u.key==="D"&&(u.preventDefault(),h(g=>!g));};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),useEffect(()=>{if(s.errorCount>=5&&o){let e=async()=>{try{await z();}catch{console.warn("[DebugPanel] Failed to auto-upload logs");}};return window.addEventListener("error",e),()=>window.removeEventListener("error",e)}},[s.errorCount,o,z]);let i=useCallback(async()=>{b(true),S(null);try{let e=await z();e.success?(S({type:"success",message:`Uploaded successfully! ${e.data?JSON.stringify(e.data):""}`}),e.data&&typeof e.data=="object"&&"url"in e.data&&await navigator.clipboard.writeText(String(e.data.url))):S({type:"error",message:`Upload failed: ${e.error}`});}catch(e){S({type:"error",message:`Error: ${e instanceof Error?e.message:"Unknown error"}`});}finally{b(false);}},[z]),a=useCallback(e=>{let u=I(e);u&&S({type:"success",message:`Downloaded: ${u}`});},[I]);return c||t==="development"||r?.role==="admin"?jsxs(Fragment,{children:[jsxs("button",{onClick:()=>h(e=>!e),style:{position:"fixed",bottom:"20px",right:"20px",zIndex:9998,padding:"12px 20px",background:"#1f2937",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:600,display:"flex",alignItems:"center",gap:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},title:"Press Ctrl+Shift+D to toggle",children:[jsx("span",{children:"\u{1F41B} Debug"}),jsx("span",{style:{background:s.errorCount>0?"#ef4444":"#374151",padding:"2px 8px",borderRadius:"12px",fontSize:"12px"},children:_}),s.errorCount>0&&jsxs("span",{style:{background:"#ef4444",padding:"2px 8px",borderRadius:"12px",fontSize:"12px"},children:[s.errorCount," err"]})]}),f&&jsxs("div",{style:{position:"fixed",bottom:"100px",right:"20px",zIndex:9999,background:"#fff",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.2)",width:"384px",maxHeight:"600px",overflow:"auto",border:"1px solid #e5e7eb"},children:[jsxs("div",{style:{background:"linear-gradient(to right, #1f2937, #111827)",color:"#fff",padding:"16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[jsxs("div",{children:[jsx("h3",{style:{margin:0,fontSize:"18px",fontWeight:700},children:"Debug Logger"}),jsxs("p",{style:{margin:"4px 0 0",fontSize:"12px",opacity:.8},children:["Session: ",P.substring(0,20),"..."]})]}),jsx("button",{onClick:()=>h(false),style:{background:"transparent",border:"none",color:"#fff",fontSize:"20px",cursor:"pointer",padding:"4px 8px"},children:"\u2715"})]}),jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"8px",padding:"12px",background:"#f9fafb",borderBottom:"1px solid #e5e7eb"},children:[jsxs("div",{style:{textAlign:"center"},children:[jsx("div",{style:{fontSize:"24px",fontWeight:700,color:"#111827"},children:_}),jsx("div",{style:{fontSize:"12px",color:"#6b7280"},children:"Total Logs"})]}),jsxs("div",{style:{textAlign:"center"},children:[jsx("div",{style:{fontSize:"24px",fontWeight:700,color:"#dc2626"},children:s.errorCount}),jsx("div",{style:{fontSize:"12px",color:"#6b7280"},children:"Errors"})]}),jsxs("div",{style:{textAlign:"center"},children:[jsx("div",{style:{fontSize:"24px",fontWeight:700,color:"#ea580c"},children:s.networkErrorCount}),jsx("div",{style:{fontSize:"12px",color:"#6b7280"},children:"Net Errors"})]})]}),jsxs("details",{style:{padding:"12px",borderBottom:"1px solid #e5e7eb",background:"#f9fafb"},children:[jsxs("summary",{style:{cursor:"pointer",fontWeight:600,color:"#374151",fontSize:"14px",listStyle:"none",display:"flex",alignItems:"center",gap:"8px"},children:[jsx("span",{children:"\u{1F4CA}"})," Session Info"]}),jsxs("div",{style:{marginTop:"8px",fontSize:"12px",color:"#4b5563",lineHeight:1.6},children:[jsxs("div",{children:[jsx("strong",{children:"User:"})," ",s.userId||"Anonymous"]}),jsxs("div",{children:[jsx("strong",{children:"Browser:"})," ",s.browser," (",s.platform,")"]}),jsxs("div",{children:[jsx("strong",{children:"Resolution:"})," ",s.screenResolution]}),jsxs("div",{children:[jsx("strong",{children:"URL:"})," ",s.url]}),jsxs("div",{children:[jsx("strong",{children:"Timezone:"})," ",s.timezone]})]})]}),jsxs("div",{style:{padding:"16px",display:"flex",flexDirection:"column",gap:"12px"},children:[jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:[jsx("label",{style:{fontSize:"14px",fontWeight:600,color:"#374151"},children:"Download Logs"}),jsxs("div",{style:{display:"flex",gap:"8px"},children:[jsx("button",{onClick:()=>a("json"),style:{flex:1,padding:"10px 16px",background:"#2563eb",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:600,transition:"background 0.2s"},onMouseOver:e=>e.currentTarget.style.background="#1d4ed8",onMouseOut:e=>e.currentTarget.style.background="#2563eb",children:"\u{1F4E5} JSON"}),jsx("button",{onClick:()=>a("txt"),style:{flex:1,padding:"10px 16px",background:"#2563eb",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:600,transition:"background 0.2s"},onMouseOver:e=>e.currentTarget.style.background="#1d4ed8",onMouseOut:e=>e.currentTarget.style.background="#2563eb",children:"\u{1F4C4} TXT"})]})]}),o&&jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:[jsx("label",{style:{fontSize:"14px",fontWeight:600,color:"#374151"},children:"Upload to Server"}),jsx("button",{onClick:i,disabled:p,style:{width:"100%",padding:"10px 16px",background:p?"#9ca3af":"#16a34a",color:"#fff",border:"none",borderRadius:"8px",cursor:p?"not-allowed":"pointer",fontSize:"14px",fontWeight:600,transition:"background 0.2s"},onMouseOver:e=>{p||(e.currentTarget.style.background="#15803d");},onMouseOut:e=>{p||(e.currentTarget.style.background="#16a34a");},children:p?"\u23F3 Uploading...":"\u2601\uFE0F Upload Logs"})]}),L&&jsx("div",{style:{padding:"12px",borderRadius:"8px",fontSize:"14px",background:L.type==="success"?"#dcfce7":"#fee2e2",color:L.type==="success"?"#166534":"#991b1b",border:`1px solid ${L.type==="success"?"#86efac":"#fca5a5"}`},children:L.message}),jsx("button",{onClick:()=>{confirm("Clear all logs? This cannot be undone.")&&(U(),S(null));},style:{width:"100%",padding:"10px 16px",background:"#dc2626",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:600,transition:"background 0.2s"},onMouseOver:e=>e.currentTarget.style.background="#b91c1c",onMouseOut:e=>e.currentTarget.style.background="#dc2626",children:"\u{1F5D1}\uFE0F Clear All Logs"})]}),jsxs("div",{style:{padding:"12px",background:"#f9fafb",borderTop:"1px solid #e5e7eb",borderRadius:"0 0 12px 12px",fontSize:"12px",color:"#6b7280"},children:[jsxs("div",{style:{marginBottom:"4px"},children:[jsx("strong",{children:"\u{1F4A1} Tip:"})," Press"," ",jsx("kbd",{style:{padding:"2px 6px",background:"#e5e7eb",borderRadius:"4px",fontFamily:"monospace"},children:"Ctrl+Shift+D"})," ","to toggle"]}),jsxs("div",{style:{marginBottom:"4px"},children:[jsx("strong",{children:"\u{1F4BE} Auto-save:"})," Logs persist across page refreshes"]}),jsxs("div",{children:[jsx("strong",{children:"\u{1F512} Security:"})," Sensitive data is auto-redacted"]})]})]})]}):null}function oe({fileNameTemplate:r="debug_{timestamp}"}){let[t,o]=useState(false),{downloadLogs:m,clearLogs:v,getLogCount:c}=F({fileNameTemplate:r}),f=c();return jsxs(Fragment,{children:[jsxs("button",{onClick:()=>o(h=>!h),style:{position:"fixed",bottom:"20px",right:"20px",zIndex:9999,padding:"12px 20px",background:"#1f2937",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:600,display:"flex",alignItems:"center",gap:"8px"},children:[jsx("span",{children:"\u{1F41B}"}),jsx("span",{children:f})]}),t&&jsxs("div",{style:{position:"fixed",bottom:"80px",right:"20px",zIndex:9999,background:"#fff",padding:"20px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.2)",width:"300px",display:"flex",flexDirection:"column",gap:"12px"},children:[jsx("button",{onClick:()=>m("json"),style:{width:"100%",padding:"10px",background:"#2563eb",color:"#fff",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"14px"},children:"Download JSON"}),jsx("button",{onClick:()=>{confirm("Clear all logs?")&&v();},style:{width:"100%",padding:"10px",background:"#dc2626",color:"#fff",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"14px"},children:"Clear Logs"}),jsx("button",{onClick:()=>o(false),style:{width:"100%",padding:"10px",background:"#6b7280",color:"#fff",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"14px"},children:"Close"})]})]})}export{ee as DebugPanel,oe as DebugPanelMinimal,W as collectMetadata,le as generateExportFilename,j as generateFilename,B as generateSessionId,A as getBrowserInfo,D as sanitizeData,M as sanitizeFilename,F as useLogRecorder};